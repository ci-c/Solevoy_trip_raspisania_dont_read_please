"""
–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–∞–º–∏ –∏ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è–º–∏.
"""

from datetime import datetime
import json
from pathlib import Path


class DisclaimerManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–≥–ª–∞—à–µ–Ω–∏–π."""

    def __init__(self, storage_path: Path):
        self.storage_path = Path(storage_path)
        self.storage_path.mkdir(parents=True, exist_ok=True)
        self.agreements_file = self.storage_path / "user_agreements.json"
        self._load_agreements()

    def _load_agreements(self) -> None:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
        if self.agreements_file.exists():
            try:
                with open(self.agreements_file, "r", encoding="utf-8") as f:
                    self.agreements = json.load(f)
            except Exception:
                self.agreements = {}
        else:
            self.agreements = {}

    def _save_agreements(self) -> None:
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
        try:
            with open(self.agreements_file, "w", encoding="utf-8") as f:
                json.dump(self.agreements, f, ensure_ascii=False, indent=2)
        except Exception:
            pass

    def has_user_agreed(self, user_id: str, version: str = "1.0") -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–æ–º."""
        user_agreement = self.agreements.get(user_id)
        if not user_agreement:
            return False

        return user_agreement.get("version") == version and user_agreement.get(
            "agreed", False
        )

    def record_user_agreement(self, user_id: str, version: str = "1.0") -> None:
        """–ó–∞–ø–∏—Å–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        self.agreements[user_id] = {
            "agreed": True,
            "version": version,
            "agreed_at": datetime.now().isoformat(),
        }
        self._save_agreements()

    def get_disclaimer_text(self) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–∞."""
        return """üìã **–í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**

üéì **–û —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è—Ö**
–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ –ø—É–±–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –°–ó–ì–ú–£.
–ü—Ä–∏ –≤–∞–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏—è—Ö –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –¥–µ–∫–∞–Ω–∞—Ç–µ.

üìö **–û —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∞—Ö**  
–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.
–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞.

ü§ù **–û –ø—Ä–æ–µ–∫—Ç–µ**
–ë–æ—Ç —Å–æ–∑–¥–∞–Ω —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏ –¥–ª—è –ø–æ–º–æ—â–∏ –≤ —É—á–µ–±–µ.
–ú—ã —Å—Ç–∞—Ä–∞–µ–º—Å—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.

‚öñÔ∏è **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**
–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–µ –Ω–µ—Å—É—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏.
–í—Å–µ–≥–¥–∞ —Å–≤–µ—Ä—è–π—Ç–µ—Å—å —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏."""

    def get_short_disclaimer(self) -> str:
        """–ö–æ—Ä–æ—Ç–∫–∏–π –¥–∏—Å–∫–ª–µ–π–º–µ—Ä –¥–ª—è —Ñ—É—Ç–µ—Ä–æ–≤."""
        return "‚ÑπÔ∏è –î–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –°–ó–ì–ú–£ ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤ –¥–µ–∫–∞–Ω–∞—Ç–µ"

    def get_welcome_agreement(self) -> str:
        """–°–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ."""
        return """‚úÖ **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!**

üìã **–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ:**
‚Ä¢ –†–∞—Å–ø–∏—Å–∞–Ω–∏—è –±–µ—Ä—É—Ç—Å—è –∏–∑ –ø—É–±–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –°–ó–ì–ú–£
‚Ä¢ –ü—Ä–∏ –≤–∞–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏—è—Ö –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤ –¥–µ–∫–∞–Ω–∞—Ç–µ
‚Ä¢ –ë–æ—Ç —Å–æ–∑–¥–∞–Ω —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏ –¥–ª—è –ø–æ–º–æ—â–∏ –≤ —É—á–µ–±–µ

–ü—Ä–æ–¥–æ–ª–∂–∞—è —Ä–∞–±–æ—Ç—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è."""
