# –ü–ª–∞–Ω —Å–∏—Å—Ç–µ–º—ã –∏–Ω–≤–∞–π—Ç–æ–≤ –∏ –ø–æ–¥–ø–∏—Å–æ–∫

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –∏–Ω–≤–∞–π—Ç–æ–≤

### 1. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

```python
@dataclass
class Invitation:
    code: str  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–Ω–≤–∞–π—Ç–∞
    created_by: str  # user_id —Å–æ–∑–¥–∞—Ç–µ–ª—è
    created_at: datetime
    expires_at: Optional[datetime]  # None = –±–µ—Å—Å—Ä–æ—á–Ω—ã–π
    max_uses: Optional[int]  # None = –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ
    current_uses: int = 0
    is_active: bool = True
    subscription_level: str = "basic"
    metadata: Dict[str, Any] = field(default_factory=dict)

@dataclass  
class UserInvitation:
    user_id: str
    invitation_code: str
    used_at: datetime
    invited_by: str
```

### 2. –£—Ä–æ–≤–Ω–∏ –¥–æ—Å—Ç—É–ø–∞

#### –ì–æ—Å—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø (guest)
- –¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ø—Ä–∞–≤–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏
- –†–∞–∑–æ–≤—ã–π –ø–æ–∏—Å–∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–Ω–≤–∞–π—Ç–∞

#### –ë–∞–∑–æ–≤—ã–π –¥–æ—Å—Ç—É–ø (basic) - –ø–æ –∏–Ω–≤–∞–π—Ç—É
- –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞
- –ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–Ω–µ–≤–Ω–∏–∫–∞ –∏ –æ—Ü–µ–Ω–æ–∫
- –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
- –°–∏—Å—Ç–µ–º–∞ –∑–∞—è–≤–ª–µ–Ω–∏–π
- –†–∞—Å—á–µ—Ç –û–°–ë/–ö–ù–õ/–ö–ù–°

#### –¢–µ—Å—Ç–µ—Ä—Å–∫–∏–π –¥–æ—Å—Ç—É–ø (tester)
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ basic
- –î–æ—Å—Ç—É–ø –∫ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–≤–∞—Ç—å 3 –∏–Ω–≤–∞–π—Ç–∞ –≤ –º–µ—Å—è—Ü

#### –ê–¥–º–∏–Ω—Å–∫–∏–π –¥–æ—Å—Ç—É–ø (admin)
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ tester
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–∞–π—Ç–∞–º–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–∞–π—Ç–æ–≤
- –î–æ—Å—Ç—É–ø –∫ –ª–æ–≥–∞–º –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ

### 3. –°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω–≤–∞–π—Ç–æ–≤

```python
class InvitationManager:
    def generate_invitation(
        self, 
        creator_id: str, 
        subscription_level: str = "basic",
        expires_in_days: Optional[int] = None,
        max_uses: Optional[int] = None
    ) -> str
    
    def validate_invitation(self, code: str) -> bool
    
    def use_invitation(self, code: str, user_id: str) -> bool
    
    def get_user_invitations(self, user_id: str) -> List[Invitation]
    
    def get_invitation_stats(self, user_id: str) -> Dict[str, Any]
```

### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –±–æ—Ç

#### Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
```python
class AccessControlMiddleware:
    async def __call__(self, handler, event, data):
        user_id = str(event.from_user.id)
        user_level = await self.get_user_access_level(user_id)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏—è–º
        if not self.check_access(handler, user_level):
            await self.show_access_denied(event)
            return
            
        data['user_access_level'] = user_level
        return await handler(event, data)
```

#### –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM
```python
class InvitationStates(StatesGroup):
    entering_code = State()
    viewing_invitations = State()
    creating_invitation = State()
    managing_users = State()  # –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É—Ä–æ–≤–Ω–µ–π –ø–æ–¥–ø–∏—Å–æ–∫

### 1. –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–¥–ø–∏—Å–∫–æ–π

```python
@dataclass
class UserSubscription:
    user_id: str
    level: str  # "guest", "basic", "tester", "admin"
    granted_at: datetime
    granted_by: str  # user_id —Ç–æ–≥–æ, –∫—Ç–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –¥–æ—Å—Ç—É–ø
    expires_at: Optional[datetime]  # None = –±–µ—Å—Å—Ä–æ—á–Ω–æ
    features: List[str] = field(default_factory=list)
    metadata: Dict[str, Any] = field(default_factory=dict)
```

### 2. –°–∏—Å—Ç–µ–º–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º

```python
FEATURE_PERMISSIONS = {
    "guest": [
        "view_attestation_info",
        "limited_schedule_search"  # –î–æ 3 –ø–æ–∏—Å–∫–æ–≤ –≤ –¥–µ–Ω—å
    ],
    "basic": [
        "create_profile",
        "full_diary",
        "unlimited_schedule_search", 
        "applications_system",
        "grade_calculator"
    ],
    "tester": [
        "all_basic_features",
        "experimental_features",
        "advanced_statistics",
        "create_invitations",  # –î–æ 3 –≤ –º–µ—Å—è—Ü
        "priority_support"
    ],
    "admin": [
        "all_tester_features",
        "user_management",
        "invitation_management",
        "system_analytics",
        "unlimited_invitations",
        "access_logs"
    ]
}
```

### 3. –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞

```python
def require_access_level(min_level: str):
    def decorator(handler):
        async def wrapper(message, state, **kwargs):
            user_level = kwargs.get('user_access_level', 'guest')
            
            if not AccessChecker.has_access(user_level, min_level):
                await message.answer("üö´ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞")
                return
                
            return await handler(message, state, **kwargs)
        return wrapper
    return decorator

def require_feature(feature_name: str):
    def decorator(handler):
        async def wrapper(message, state, **kwargs):
            user_level = kwargs.get('user_access_level', 'guest')
            
            if not AccessChecker.has_feature(user_level, feature_name):
                await message.answer("üö´ –§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –≤–∞—à–µ–≥–æ —É—Ä–æ–≤–Ω—è –¥–æ—Å—Ç—É–ø–∞")
                return
                
            return await handler(message, state, **kwargs)
        return wrapper
    return decorator
```

## UX –¥–ª—è –∏–Ω–≤–∞–π—Ç-—Å–∏—Å—Ç–µ–º—ã

### 1. –î–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (guest)

```
üéì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –°–ó–ì–ú–£ –ë–æ—Ç!

üëÄ –î–æ—Å—Ç—É–ø–Ω–æ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:
‚Ä¢ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏
‚Ä¢ –†–∞–∑–æ–≤—ã–π –ø–æ–∏—Å–∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π (3 –≤ –¥–µ–Ω—å)

üîë –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –Ω—É–∂–µ–Ω –∏–Ω–≤–∞–π—Ç-–∫–æ–¥
[–í–≤–µ—Å—Ç–∏ –∫–æ–¥] [–ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø]
```

### 2. –í–≤–æ–¥ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞

```
üîë –í–≤–µ–¥–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥:

–ö–æ–¥ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –±–æ—Ç–∞.

[–û—Ç–º–µ–Ω–∞]
```

### 3. –£—Å–ø–µ—à–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è

```
‚úÖ –ò–Ω–≤–∞–π—Ç-–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!

üéâ –¢–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏:
‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
‚Ä¢ –î–Ω–µ–≤–Ω–∏–∫ –∏ –æ—Ü–µ–Ω–∫–∏  
‚Ä¢ –†–∞—Å—á–µ—Ç –û–°–ë/–ö–ù–õ/–ö–ù–°
‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –∑–∞—è–≤–ª–µ–Ω–∏–π

[–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å] [–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é]
```

### 4. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–∞–π—Ç–∞–º–∏ (–¥–ª—è —Ç–µ—Å—Ç–µ—Ä–æ–≤/–∞–¥–º–∏–Ω–æ–≤)

```
üîë –ú–æ–∏ –∏–Ω–≤–∞–π—Ç—ã

üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚Ä¢ –°–æ–∑–¥–∞–Ω–æ: 5
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: 3
‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ: 2 (–ª–∏–º–∏—Ç: 3/–º–µ—Å)

[–°–æ–∑–¥–∞—Ç—å –∏–Ω–≤–∞–π—Ç] [–ò—Å—Ç–æ—Ä–∏—è] [–ù–∞—Å—Ç—Ä–æ–π–∫–∏]
```

## –≠—Ç–∞–ø—ã –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–≤–∞–π—Ç–æ–≤
1. –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å InvitationManager
3. –î–æ–±–∞–≤–∏—Ç—å middleware –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
4. –ë–∞–∑–æ–≤—ã–π UX –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–æ–≤

### –≠—Ç–∞–ø 2: –£—Ä–æ–≤–Ω–∏ –ø–æ–¥–ø–∏—Å–æ–∫  
1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å UserSubscription
2. –î–æ–±–∞–≤–∏—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –¥–æ—Å—Ç—É–ø–∞
3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
4. –°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

### –≠—Ç–∞–ø 3: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
1. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º
3. –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
4. API –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

### –≠—Ç–∞–ø 4: –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
1. –ü—Ä–µ–º–∏—É–º-–ø–æ–¥–ø–∏—Å–∫–∏ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏
2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
3. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
4. –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è –¥–µ–∫–∞–Ω–∞—Ç–æ–≤

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- SQLite –¥–ª—è –∏–Ω–≤–∞–π—Ç–æ–≤ –∏ –ø–æ–¥–ø–∏—Å–æ–∫
- JSON –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞
- Redis –¥–ª—è rate limiting (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å  
- –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–æ–≤
- Rate limiting –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–∞–π—Ç–æ–≤
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π —Å –¥–æ—Å—Ç—É–ø–æ–º
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∞–≤ –Ω–∞ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –ú–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ —É—Ä–æ–≤–Ω—è–º
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∏–Ω–≤–∞–π—Ç–æ–≤
- –¢—Ä–µ–∫–∏–Ω–≥ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- –°–∏—Å—Ç–µ–º–∞ –∞–ª–µ—Ä—Ç–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤